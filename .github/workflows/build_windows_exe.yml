name: Build Windows EXE

on:
  push:
    branches: ['main', 'master']
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' 

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build EXE
        run: |
          cd Canada28
          # 使用与本地 build_exe.py 一致的命令 (仅打包主程序)
          pyinstaller --name="Canada28Simulator" --onefile --noconsole --clean `
            --hidden-import=generate_top_combinations `
            --hidden-import=license_manager `
            --hidden-import=activate_dialog `
            --hidden-import=PyQt5 `
            --hidden-import=PyQt5.QtWebEngineWidgets `
            --hidden-import=requests `
            --hidden-import=openpyxl `
            --hidden-import=matplotlib `
            --hidden-import=numpy `
            --collect-all=PyQt5 `
            canada28_simulator_qt.py

      - name: Prepare Distribution Package
        run: |
          cd Canada28
          # 复制 Data 文件夹到 dist/Data
          if (Test-Path "Data") {
              Copy-Item -Path "Data" -Destination "dist/Data" -Recurse -Force
              Write-Host "✅ Data folder copied."
          } else {
              Write-Warning "⚠️ Data folder not found in repository."
          }
          
          # 由于 GitHub Action 上传 Artifact 时会自动打包成 ZIP，
          # 所以这里不需要手动压缩，直接上传 dist 目录的内容即可
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Canada28Simulator_Package
          path: Canada28/dist/
